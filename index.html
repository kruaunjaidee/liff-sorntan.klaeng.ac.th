<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸­à¸™à¹à¸—à¸™</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
  <style>
    * { box-sizing: border-box; }
    body { font-family: "Kanit", sans-serif; }
    .glow-green { text-shadow: 0 0 8px rgba(74,222,128,0.9), 0 0 20px rgba(74,222,128,0.5); }
    .glow-blue  { text-shadow: 0 0 6px rgba(99,179,237,0.8); }
    .glow-pink  { text-shadow: 0 0 6px rgba(236,72,153,0.8); }

    .glass-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    select, input[type="text"] {
      background: rgba(30,41,59,0.8) !important;
      border: 1.5px solid rgba(99,179,237,0.3) !important;
      color: #fff !important;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    select:focus, input[type="text"]:focus {
      border-color: #4ade80 !important;
      box-shadow: 0 0 0 3px rgba(74,222,128,0.2) !important;
      outline: none;
    }
    select option { background: #1e293b; color: #fff; }

    .upload-zone {
      border: 2px dashed rgba(99,179,237,0.4);
      transition: border-color 0.2s, background 0.2s;
      cursor: pointer;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #4ade80;
      background: rgba(74,222,128,0.05);
    }
    .upload-zone img { max-height: 160px; object-fit: contain; }

    .page { display: none; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .confirm-row {
      display: flex; justify-content: space-between;
      padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .confirm-row:last-child { border-bottom: none; }
    .confirm-label { color: #94a3b8; font-size: 0.85rem; }
    .confirm-value { color: #fff; font-weight: 600; font-size: 0.9rem; text-align: right; max-width: 62%; }

    .btn-primary { background: linear-gradient(135deg,#3b82f6,#1d4ed8); transition: all 0.2s; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59,130,246,0.4); }
    .btn-success { background: linear-gradient(135deg,#22c55e,#15803d); transition: all 0.2s; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34,197,94,0.4); }
    .btn-gray { background: rgba(71,85,105,0.6); border: 1px solid rgba(148,163,184,0.2); transition: all 0.2s; }
    .btn-gray:hover { background: rgba(100,116,139,0.6); transform: translateY(-2px); }

    .badge-blue {
      background: rgba(59,130,246,0.2); color: #93c5fd;
      border: 1px solid rgba(59,130,246,0.3);
      border-radius: 9999px; padding: 2px 10px; font-size: 0.75rem;
    }

    #loadingOverlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.7); z-index: 9999;
      align-items: center; justify-content: center;
      flex-direction: column; gap: 16px;
    }
    #loadingOverlay.show { display: flex; }
    .spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(74,222,128,0.2); border-top-color: #4ade80;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #toast {
      position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
      background: #1e293b; border: 1px solid #4ade80; color: #fff;
      padding: 12px 24px; border-radius: 12px; font-size: 0.9rem;
      z-index: 9998; opacity: 0; transition: opacity 0.3s;
      pointer-events: none; white-space: nowrap;
    }
    #toast.show { opacity: 1; }

    #imgPreviewWrapper { position: relative; }
    #removeImgBtn {
      position: absolute; top: 8px; right: 8px;
      background: rgba(239,68,68,0.8); border: none; color: #fff;
      width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
      font-size: 1rem; display: flex; align-items: center; justify-content: center;
    }

    /* LIFF Status Badge */
    .liff-badge {
      display: inline-flex; align-items: center;
      font-size: 0.7rem; padding: 3px 10px; border-radius: 9999px;
      font-weight: 600; letter-spacing: 0.02em;
      border: 1px solid; transition: all 0.3s;
    }
    .liff-badge-ok    { background: rgba(34,197,94,0.15);  color: #4ade80; border-color: rgba(34,197,94,0.4); }
    .liff-badge-info  { background: rgba(59,130,246,0.15); color: #93c5fd; border-color: rgba(59,130,246,0.4); }
    .liff-badge-warn  { background: rgba(234,179,8,0.15);  color: #fde047; border-color: rgba(234,179,8,0.4); }
    .liff-badge-error { background: rgba(239,68,68,0.15);  color: #fca5a5; border-color: rgba(239,68,68,0.4); }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black text-white min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 pb-24">

  <!-- LOADING -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p class="text-green-400 font-semibold text-sm" id="loadingText">à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...</p>
  </div>

  <div id="toast"></div>

  <!-- HEADER -->
  <div class="text-center mb-6 mt-2">
    <img src="https://lh3.googleusercontent.com/d/1hTcB5YnvnJtMg0l4fIO5Jo20QbKF5_wh"
      class="w-28 h-auto mb-3 mx-auto rounded-xl shadow-lg" onerror="this.style.display='none'" />
    <h3 class="text-2xl sm:text-3xl font-bold glow-green tracking-wide">à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸­à¸™à¹à¸—à¸™</h3>
    <p class="text-sm text-slate-400 mt-1">à¸„à¸£à¸¹à¸‚à¸²à¸” â€¢ à¸¥à¸² â€¢ à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£</p>
    <h5 class="text-base text-pink-400 glow-pink mt-1">à¸„à¸£à¸¹à¸­à¸±à¹‹à¸™ à¹ƒà¸ˆà¸”à¸µ</h5>
    <!-- LIFF Status Badge â€” à¸­à¸±à¸à¹€à¸”à¸—à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸«à¸¥à¸±à¸‡ liff.init() -->
    <div class="mt-2 flex justify-center">
      <span id="liffStatusBadge" class="liff-badge liff-badge-warn hidden">
        <i class="bi bi-arrow-repeat mr-1"></i>à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ LINE...
      </span>
    </div>
  </div>

  <!-- PAGE 1: FORM -->
  <div class="page active w-full max-w-xl" id="page-form">
    <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8 space-y-5">

      <div class="flex items-center gap-2 mb-2">
        <i class="bi bi-pencil-square text-green-400 text-xl"></i>
        <span class="font-semibold text-lg glow-green">à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸ªà¸­à¸™à¹à¸—à¸™</span>
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-person-x-fill mr-1 text-red-400"></i>à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸¥à¸²à¸ªà¸­à¸™
        </label>
        <select id="nameTeacher" class="w-full rounded-xl p-3 text-white" required>
          <option value="" disabled selected>â€” à¹€à¸¥à¸·à¸­à¸à¸œà¸¹à¹‰à¸¥à¸²à¸ªà¸­à¸™ â€”</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸­à¸²à¸£à¸µ à¸šà¸±à¸§à¸„à¸¸à¹‰à¸¡à¸ à¸±à¸¢</option>
          <option>à¸™à¸²à¸¢à¸›à¸£à¸°à¸¢à¸¸à¸—à¸˜à¹Œ à¹„à¸—à¸£à¸¢à¹‰à¸­à¸¢à¸ªà¸à¸¸à¸¥à¹€à¸¥à¸´à¸¨</option>
          <option>à¸™à¸²à¸¢à¸ªà¸¸à¸ à¸±à¸—à¸£à¸à¸‡à¸¨à¹Œ à¸£à¸§à¸‡à¸œà¸¶à¹‰à¸‡à¸£à¸¸à¹ˆà¸‡à¹‚à¸£à¸ˆà¸™à¹Œ</option>
          <option>à¸™à¸²à¸‡à¸›à¸™à¸±à¸¨à¸à¸² à¹€à¸ˆà¸£à¸´à¸à¸¡à¸²à¸</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸ªà¸¸à¸§à¸²à¸“à¸µ à¸˜à¸£à¸£à¸¡à¸¨à¸£à¸µ</option>
          <option>à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸¢à¸•à¸£à¸µà¸«à¸à¸´à¸‡à¸ à¸²à¸£à¸´à¸©à¸² à¸˜à¸™à¸ªà¸´à¸£à¸´à¸‡à¸²à¸¡</option>
          <option>à¸™à¸²à¸‡à¸¡à¸“à¸‘à¸²à¸—à¸´à¸à¸¢à¹Œ à¸„à¸µà¸£à¸µà¸ªà¸¸à¸—à¸˜à¸´à¸§à¸‡à¸¨à¹Œ</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸ªà¸¸à¸›à¸²à¸“à¸µ à¸­à¸´à¸™à¸­à¸‡à¸à¸²à¸£</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸™à¸¸à¸Šà¸™à¸²à¸ à¹à¸–à¸¥à¸‡à¸ªà¸±à¸•à¸¢à¹Œ</option>
          <option>à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸¢à¸•à¸£à¸µà¸«à¸à¸´à¸‡à¸­à¸¸à¸šà¸¥à¸§à¸£à¸£à¸“ à¸à¸±à¸™à¸•à¸°à¹à¸à¹‰à¸§</option>
          <option>à¸™à¸²à¸¢à¸“à¸±à¸à¸à¸¥ à¹€à¸™à¸µà¸¢à¸¡à¸à¸´à¸—à¸±à¸à¸©à¹Œ</option>
          <option>à¸™à¸²à¸¢à¸ªà¸±à¸¡à¸¤à¸—à¸˜à¸´à¹Œ à¸¡à¸µà¸—à¸£à¸±à¸à¸¢à¹Œà¸¡à¸±à¹ˆà¸™</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¹€à¸à¸Šà¸£à¸™à¸ à¸² à¸œà¸²à¸”à¸œà¹ˆà¸­à¸‡</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸¡à¸±à¸—à¸§à¸±à¸™ à¸¨à¸£à¸µà¸ à¸±à¸à¸”à¸µ</option>
          <option>à¸™à¸²à¸¢à¸ªà¸£à¸™à¸±à¸™à¸—à¹Œ à¸ªà¸²à¸¢à¸”à¸µ</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-person-check-fill mr-1 text-green-400"></i>à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸ªà¸­à¸™à¹à¸—à¸™
        </label>
        <select id="nameTeacherSave" class="w-full rounded-xl p-3 text-white" required>
          <option value="" disabled selected>â€” à¹€à¸¥à¸·à¸­à¸à¸œà¸¹à¹‰à¸ªà¸­à¸™à¹à¸—à¸™ â€”</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸­à¸²à¸£à¸µ à¸šà¸±à¸§à¸„à¸¸à¹‰à¸¡à¸ à¸±à¸¢</option>
          <option>à¸™à¸²à¸¢à¸›à¸£à¸°à¸¢à¸¸à¸—à¸˜à¹Œ à¹„à¸—à¸£à¸¢à¹‰à¸­à¸¢à¸ªà¸à¸¸à¸¥à¹€à¸¥à¸´à¸¨</option>
          <option>à¸™à¸²à¸¢à¸ªà¸¸à¸ à¸±à¸—à¸£à¸à¸‡à¸¨à¹Œ à¸£à¸§à¸‡à¸œà¸¶à¹‰à¸‡à¸£à¸¸à¹ˆà¸‡à¹‚à¸£à¸ˆà¸™à¹Œ</option>
          <option>à¸™à¸²à¸‡à¸›à¸™à¸±à¸¨à¸à¸² à¹€à¸ˆà¸£à¸´à¸à¸¡à¸²à¸</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸ªà¸¸à¸§à¸²à¸“à¸µ à¸˜à¸£à¸£à¸¡à¸¨à¸£à¸µ</option>
          <option>à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸¢à¸•à¸£à¸µà¸«à¸à¸´à¸‡à¸ à¸²à¸£à¸´à¸©à¸² à¸˜à¸™à¸ªà¸´à¸£à¸´à¸‡à¸²à¸¡</option>
          <option>à¸™à¸²à¸‡à¸¡à¸“à¸‘à¸²à¸—à¸´à¸à¸¢à¹Œ à¸„à¸µà¸£à¸µà¸ªà¸¸à¸—à¸˜à¸´à¸§à¸‡à¸¨à¹Œ</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸ªà¸¸à¸›à¸²à¸“à¸µ à¸­à¸´à¸™à¸­à¸‡à¸à¸²à¸£</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸™à¸¸à¸Šà¸™à¸²à¸ à¹à¸–à¸¥à¸‡à¸ªà¸±à¸•à¸¢à¹Œ</option>
          <option>à¸§à¹ˆà¸²à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸¢à¸•à¸£à¸µà¸«à¸à¸´à¸‡à¸­à¸¸à¸šà¸¥à¸§à¸£à¸£à¸“ à¸à¸±à¸™à¸•à¸°à¹à¸à¹‰à¸§</option>
          <option>à¸™à¸²à¸¢à¸“à¸±à¸à¸à¸¥ à¹€à¸™à¸µà¸¢à¸¡à¸à¸´à¸—à¸±à¸à¸©à¹Œ</option>
          <option>à¸™à¸²à¸¢à¸ªà¸±à¸¡à¸¤à¸—à¸˜à¸´à¹Œ à¸¡à¸µà¸—à¸£à¸±à¸à¸¢à¹Œà¸¡à¸±à¹ˆà¸™</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¹€à¸à¸Šà¸£à¸™à¸ à¸² à¸œà¸²à¸”à¸œà¹ˆà¸­à¸‡</option>
          <option>à¸™à¸²à¸‡à¸ªà¸²à¸§à¸¡à¸±à¸—à¸§à¸±à¸™ à¸¨à¸£à¸µà¸ à¸±à¸à¸”à¸µ</option>
          <option>à¸™à¸²à¸¢à¸ªà¸£à¸™à¸±à¸™à¸—à¹Œ à¸ªà¸²à¸¢à¸”à¸µ</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-clock-fill mr-1 text-yellow-400"></i>à¸„à¸²à¸šà¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™
        </label>
        <select id="numberAtPeriod" class="w-full rounded-xl p-3 text-white" required>
          <option value="" disabled selected>â€” à¹€à¸¥à¸·à¸­à¸à¸„à¸²à¸šà¸—à¸µà¹ˆà¸ªà¸­à¸™ â€”</option>
          <option value="1">à¸„à¸²à¸š 1</option><option value="2">à¸„à¸²à¸š 2</option>
          <option value="3">à¸„à¸²à¸š 3</option><option value="4">à¸„à¸²à¸š 4</option>
          <option value="5">à¸„à¸²à¸š 5</option><option value="6">à¸„à¸²à¸š 6</option>
          <option value="7">à¸„à¸²à¸š 7</option><option value="8">à¸„à¸²à¸š 8</option>
          <option value="9">à¸„à¸²à¸š 9</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-book-fill mr-1 text-blue-400"></i>à¸§à¸´à¸Šà¸²à¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™
        </label>
        <input type="text" id="subjectSave" class="w-full rounded-xl p-3"
          placeholder="à¹€à¸Šà¹ˆà¸™ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢, à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ" required />
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-door-open-fill mr-1 text-purple-400"></i>à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™
        </label>
        <input type="text" id="subjectRoom" class="w-full rounded-xl p-3"
          placeholder="à¹€à¸Šà¹ˆà¸™ à¸¡.2/1, à¸¡.3/4" required />
      </div>

      <div>
        <label class="block text-sm font-medium glow-blue mb-1">
          <i class="bi bi-image-fill mr-1 text-pink-400"></i>à¹à¸™à¸šà¸ à¸²à¸à¸›à¸£à¸°à¸à¸­à¸š
          <span class="badge-blue ml-1">à¹„à¸¡à¹ˆà¸šà¸±à¸‡à¸„à¸±à¸š</span>
        </label>
        <div id="uploadZone" class="upload-zone rounded-xl p-4 text-center">
          <div id="uploadPlaceholder">
            <i class="bi bi-cloud-arrow-up-fill text-3xl text-slate-400 block mb-2"></i>
            <p class="text-sm text-slate-400">à¸„à¸¥à¸´à¸à¸«à¸£à¸·à¸­à¸¥à¸²à¸à¹„à¸Ÿà¸¥à¹Œà¸¡à¸²à¸§à¸²à¸‡à¸—à¸µà¹ˆà¸™à¸µà¹ˆ</p>
            <p class="text-xs text-slate-500 mt-1">à¸£à¸­à¸‡à¸£à¸±à¸š JPG, PNG, WEBP (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5MB)</p>
          </div>
          <div id="imgPreviewWrapper" class="hidden">
            <img id="imgPreview" src="" alt="preview" class="mx-auto rounded-lg" />
            <button id="removeImgBtn" type="button" title="à¸¥à¸šà¸ à¸²à¸">Ã—</button>
          </div>
          <input type="file" id="fileInput" accept="image/*" class="hidden" />
        </div>
      </div>

      <button type="button" id="goConfirmBtn"
        class="btn-primary w-full text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 text-base mt-2">
        <i class="bi bi-arrow-right-circle-fill"></i> à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡
      </button>
    </div>
  </div>

  <!-- PAGE 2: CONFIRM -->
  <div class="page w-full max-w-xl" id="page-confirm">
    <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8">

      <div class="flex items-center gap-2 mb-5">
        <i class="bi bi-check2-circle text-green-400 text-2xl"></i>
        <span class="font-bold text-xl glow-green">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¹ˆà¸­à¸™à¸ªà¹ˆà¸‡</span>
      </div>

      <div id="confirmImgBlock" class="hidden mb-4">
        <img id="confirmImgPreview" src=""
          class="w-full max-h-44 object-cover rounded-xl border border-slate-600" />
      </div>

      <div class="space-y-1 mb-6">
        <div class="confirm-row"><span class="confirm-label">ğŸ‘©â€ğŸ« à¸œà¸¹à¹‰à¸¥à¸²à¸ªà¸­à¸™</span><span class="confirm-value" id="c-nameTeacher">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">ğŸ‘¨â€ğŸ« à¸œà¸¹à¹‰à¸ªà¸­à¸™à¹à¸—à¸™</span><span class="confirm-value" id="c-nameTeacherSave">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">â° à¸„à¸²à¸šà¸—à¸µà¹ˆ</span><span class="confirm-value" id="c-numberAtPeriod">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">ğŸ“– à¸§à¸´à¸Šà¸²</span><span class="confirm-value" id="c-subjectSave">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">ğŸ« à¸«à¹‰à¸­à¸‡</span><span class="confirm-value" id="c-subjectRoom">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ</span><span class="confirm-value" id="c-date">â€”</span></div>
        <div class="confirm-row"><span class="confirm-label">ğŸ• à¹€à¸§à¸¥à¸²</span><span class="confirm-value" id="c-time">â€”</span></div>
      </div>

      <p id="confirmHint" class="text-sm text-slate-400 text-center mb-5">
        <i class="bi bi-info-circle mr-1"></i>
        à¸à¸”à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ <strong class="text-green-400">à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œ LINE à¸—à¸±à¸™à¸—à¸µ</strong> â†’ à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
      </p>

      <div class="flex gap-3">
        <button id="backBtn"
          class="btn-gray flex-1 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2">
          <i class="bi bi-arrow-left-circle"></i> à¹à¸à¹‰à¹„à¸‚
        </button>
        <!--
          â­ submitBtn = user gesture à¸ˆà¸£à¸´à¸‡
             à¸à¸”à¹à¸¥à¹‰à¸§ â†’ shareTargetPicker à¹€à¸›à¸´à¸”à¸—à¸±à¸™à¸—à¸µ (synchronous)
             â†’ à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡ â†’ .then() â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Sheet
        -->
        <button id="submitBtn"
          class="btn-success flex-1 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 text-base">
          <i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¸°à¸ªà¹ˆà¸‡
        </button>
      </div>
    </div>
  </div>

  <footer class="fixed bottom-0 w-full bg-slate-900/80 backdrop-blur-sm text-center py-3 text-xs text-pink-400 glow-pink z-40">
    â¤ï¸ à¸à¸±à¸’à¸™à¸²à¹‚à¸”à¸¢ à¸„à¸£à¸¹à¸­à¸±à¹‹à¸™ à¹ƒà¸ˆà¸”à¸µ Â© <span id="year"></span>
  </footer>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
  // ============================================================
  // CONFIG
  // ============================================================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8FMpndZve9-cBaR76IBFDxHSFpZtNt_k5WyJ-mPtTO5GHaTf64dlz79kkwTufpDhP/exec";
  const LIFF_ID    = "2000563749-Yh67UIqr";

  // default image à¹ƒà¸Šà¹‰à¹€à¸¡à¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸¹à¸›à¸«à¸£à¸·à¸­à¸£à¸¹à¸›à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹„à¸”à¹‰ upload à¸‚à¸¶à¹‰à¸™ Drive
  const DEFAULT_IMG = "https://lh3.googleusercontent.com/d/1hTcB5YnvnJtMg0l4fIO5Jo20QbKF5_wh";

  // ============================================================
  // STATE
  // ============================================================
  let uploadedImageBase64 = null;
  let isSubmitting = false;

  // ============================================================
  // HELPERS
  // ============================================================
  function showPage(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function showLoading(text = "à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...") {
    document.getElementById("loadingText").textContent = text;
    document.getElementById("loadingOverlay").classList.add("show");
  }
  function hideLoading() {
    document.getElementById("loadingOverlay").classList.remove("show");
  }

  function showToast(msg, duration = 3500) {
    const t = document.getElementById("toast");
    t.textContent = msg; t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), duration);
  }

  function getThaiDate() {
    const d = new Date();
    const days   = ["à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ","à¸ˆà¸±à¸™à¸—à¸£à¹Œ","à¸­à¸±à¸‡à¸„à¸²à¸£","à¸à¸¸à¸˜","à¸à¸¤à¸«à¸±à¸ªà¸šà¸”à¸µ","à¸¨à¸¸à¸à¸£à¹Œ","à¹€à¸ªà¸²à¸£à¹Œ"];
    const months = ["à¸¡.à¸„.","à¸.à¸.","à¸¡à¸µ.à¸„.","à¹€à¸¡.à¸¢.","à¸.à¸„.","à¸¡à¸´.à¸¢.","à¸.à¸„.","à¸ª.à¸„.","à¸.à¸¢.","à¸•.à¸„.","à¸.à¸¢.","à¸˜.à¸„."];
    return `à¸§à¸±à¸™${days[d.getDay()]}à¸—à¸µà¹ˆ ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
  }
  function getThaiTime() {
    return new Date().toLocaleTimeString("th-TH", { hour:"2-digit", minute:"2-digit" }) + " à¸™.";
  }

  // ============================================================
  // IMAGE UPLOAD
  // ============================================================
  const uploadZone        = document.getElementById("uploadZone");
  const fileInput         = document.getElementById("fileInput");
  const imgPreview        = document.getElementById("imgPreview");
  const imgPreviewWrapper = document.getElementById("imgPreviewWrapper");
  const uploadPlaceholder = document.getElementById("uploadPlaceholder");

  uploadZone.addEventListener("click", () => fileInput.click());
  uploadZone.addEventListener("dragover",  e => { e.preventDefault(); uploadZone.classList.add("dragover"); });
  uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
  uploadZone.addEventListener("drop", e => {
    e.preventDefault(); uploadZone.classList.remove("dragover");
    if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener("change", () => { if (fileInput.files[0]) processFile(fileInput.files[0]); });

  function processFile(file) {
    if (!file.type.startsWith("image/")) { showToast("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¹„à¸Ÿà¸¥à¹Œà¸£à¸¹à¸›à¸ à¸²à¸à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™"); return; }
    if (file.size > 5 * 1024 * 1024)     { showToast("âš ï¸ à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸«à¸à¹ˆà¹€à¸à¸´à¸™ 5MB"); return; }
    const reader = new FileReader();
    reader.onload = e => {
      uploadedImageBase64 = e.target.result.split(",")[1];
      imgPreview.src = e.target.result;
      imgPreviewWrapper.classList.remove("hidden");
      uploadPlaceholder.classList.add("hidden");
    };
    reader.readAsDataURL(file);
  }

  document.getElementById("removeImgBtn").addEventListener("click", e => {
    e.stopPropagation();
    uploadedImageBase64 = null; fileInput.value = "";
    imgPreviewWrapper.classList.add("hidden");
    uploadPlaceholder.classList.remove("hidden");
  });

  // ============================================================
  // PAGE 1 â†’ PAGE 2 (Confirm)
  // ============================================================
  document.getElementById("goConfirmBtn").addEventListener("click", () => {
    const fields = [
      { id:"nameTeacher",    label:"à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸¥à¸²à¸ªà¸­à¸™" },
      { id:"nameTeacherSave",label:"à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸ªà¸­à¸™à¹à¸—à¸™" },
      { id:"numberAtPeriod", label:"à¸„à¸²à¸šà¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™" },
      { id:"subjectSave",    label:"à¸§à¸´à¸Šà¸²à¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™" },
      { id:"subjectRoom",    label:"à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™" },
    ];
    for (const f of fields) {
      const el = document.getElementById(f.id);
      if (!el.value.trim()) { showToast(`âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸: ${f.label}`); el.focus(); return; }
    }

    document.getElementById("c-nameTeacher").textContent    = document.getElementById("nameTeacher").value;
    document.getElementById("c-nameTeacherSave").textContent = document.getElementById("nameTeacherSave").value;
    document.getElementById("c-numberAtPeriod").textContent  = "à¸„à¸²à¸š " + document.getElementById("numberAtPeriod").value;
    document.getElementById("c-subjectSave").textContent    = document.getElementById("subjectSave").value;
    document.getElementById("c-subjectRoom").textContent    = document.getElementById("subjectRoom").value;
    document.getElementById("c-date").textContent           = getThaiDate();
    document.getElementById("c-time").textContent           = getThaiTime();

    if (uploadedImageBase64) {
      document.getElementById("confirmImgPreview").src = imgPreview.src;
      document.getElementById("confirmImgBlock").classList.remove("hidden");
    } else {
      document.getElementById("confirmImgBlock").classList.add("hidden");
    }

    showPage("page-confirm");
  });

  document.getElementById("backBtn").addEventListener("click", () => showPage("page-form"));

  // ============================================================
  // SUBMIT BUTTON
  //
  // à¹à¸¢à¸ 2 à¸Šà¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¹ˆà¸²à¸‡à¸Šà¸±à¸”à¹€à¸ˆà¸™:
  //
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 1 â€” à¸¡à¸·à¸­à¸–à¸·à¸­ (LINE in-app browser)
  //   liff.isInClient() = true
  //   â–¶ à¹€à¸£à¸µà¸¢à¸ shareTargetPicker() à¸—à¸±à¸™à¸—à¸µà¸ˆà¸²à¸ click (synchronous)
  //   â–¶ LINE SDK à¸£à¸±à¸šà¸£à¸­à¸‡à¸§à¹ˆà¸²à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ gesture stack â†’ à¹„à¸¡à¹ˆà¸¡à¸µ error
  //   â–¶ à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡à¹ƒà¸™ LINE â†’ .then() â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Sheet
  //
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 2 â€” Web Browser (à¸„à¸­à¸¡ / à¸¡à¸·à¸­à¸–à¸·à¸­à¹€à¸›à¸´à¸”à¸œà¹ˆà¸²à¸™ browser)
  //   liff.isInClient() = false
  //   â–¶ à¸šà¸±à¸™à¸—à¸¶à¸ Sheet à¸à¹ˆà¸­à¸™ (ajax)
  //   â–¶ à¸«à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ â†’ à¹€à¸£à¸µà¸¢à¸ shareTargetPicker() à¸œà¹ˆà¸²à¸™ LIFF
  //     external login (withLoginOnExternalBrowser: true)
  //   â–¶ LINE à¸ˆà¸°à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸•à¹ˆà¸²à¸‡à¹€à¸¥à¸·à¸­à¸ chat à¸šà¸™ browser
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  document.getElementById("submitBtn").addEventListener("click", function () {
    if (isSubmitting) return;

    const btn = this;

    const formData = {
      opt:             "savedata",
      nameTeacher:     document.getElementById("nameTeacher").value,
      nameTeacherSave: document.getElementById("nameTeacherSave").value,
      numberAtPeriod:  document.getElementById("numberAtPeriod").value,
      subjectSave:     document.getElementById("subjectSave").value,
      subjectRoom:     document.getElementById("subjectRoom").value,
      thaiDate:        getThaiDate(),
      thaiTime:        getThaiTime(),
      imageBase64:     uploadedImageBase64 || "",
    };

    try {
      const token = liff.getDecodedIDToken();
      formData.uid   = token?.sub     || "";
      formData.uname = token?.name    || "";
      formData.uimg  = token?.picture || "";
    } catch(e) {}

    const flexMsg = buildFlexMessage(formData, DEFAULT_IMG);

    if (liff.isInClient()) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 1: à¸¡à¸·à¸­à¸–à¸·à¸­ â€” LINE in-app browser
      // shareTargetPicker à¹€à¸£à¸µà¸¢à¸ synchronous à¸ˆà¸²à¸ click à¸—à¸±à¸™à¸—à¸µ
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      btn.disabled = true;
      btn.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>à¸à¸³à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œ LINE...`;

      liff.shareTargetPicker([flexMsg], { isMultiple: true })
        .then((res) => {
          // à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡à¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¸à¸” X â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Sheet à¹€à¸ªà¸¡à¸­
          doSaveToSheet(formData, btn,
            res ? "âœ… à¹à¸Šà¸£à¹Œà¹à¸¥à¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!" : "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! (à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹à¸Šà¸£à¹Œ)");
        })
        .catch((err) => {
          console.error("[Mobile] shareTargetPicker error:", err);
          btn.disabled = false;
          btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
          Swal.fire({
            icon: "warning",
            title: "à¹à¸Šà¸£à¹Œà¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ (à¸¡à¸·à¸­à¸–à¸·à¸­)",
            html: `<p>à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¹à¸Šà¸£à¹Œà¹„à¸«à¸¡?<br>
                   <small style="color:#94a3b8">${err?.message || err}</small></p>`,
            confirmButtonText: "à¸šà¸±à¸™à¸—à¸¶à¸à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¸µà¸¢à¸§",
            confirmButtonColor: "#3b82f6",
            showCancelButton: true,
            cancelButtonText: "à¸¢à¸à¹€à¸¥à¸´à¸",
            background: "#1e293b", color: "#fff",
          }).then(r => { if (r.isConfirmed) doSaveToSheet(formData, btn, "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"); });
        });

    } else {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 2: Web Browser â€” à¸šà¸±à¸™à¸—à¸¶à¸ Sheet à¸à¹ˆà¸­à¸™ â†’ à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢ share
      // (browser à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£ synchronous gesture à¸ªà¸³à¸«à¸£à¸±à¸š LIFF external)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      btn.disabled = true;
      btn.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...`;
      showLoading("à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥...");
      isSubmitting = true;

      $.ajax({
        method: "POST", url: SCRIPT_URL, data: formData, dataType: "json",
        success: (res) => {
          hideLoading();
          isSubmitting = false;

          if (res.status === "success") {
            btn.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>à¸à¸³à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œ LINE...`;

            // à¸šà¸±à¸™à¸—à¸¶à¸à¹à¸¥à¹‰à¸§ â†’ à¹€à¸›à¸´à¸” shareTargetPicker à¸šà¸™ browser
            liff.shareTargetPicker([flexMsg], { isMultiple: true })
              .then((shareRes) => {
                btn.disabled = false;
                btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
                showToast(shareRes ? "âœ… à¹à¸Šà¸£à¹Œà¹à¸¥à¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!" : "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! (à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹à¸Šà¸£à¹Œ)");
                resetForm();
                showPage("page-form");
              })
              .catch((err) => {
                console.error("[Browser] shareTargetPicker error:", err);
                btn.disabled = false;
                btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
                // à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§ à¹à¸„à¹ˆ share à¹„à¸¡à¹ˆà¹„à¸”à¹‰
                Swal.fire({
                  icon: "info",
                  title: "à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§",
                  html: `<p>à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œà¹„à¸”à¹‰<br>
                         <small style="color:#94a3b8">${err?.message || err}</small></p>`,
                  confirmButtonText: "à¸•à¸à¸¥à¸‡",
                  confirmButtonColor: "#22c55e",
                  background: "#1e293b", color: "#fff",
                }).then(() => { resetForm(); showPage("page-form"); });
              });

          } else {
            btn.disabled = false;
            btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
            Swal.fire({ icon: "error", title: "à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
              text: res.message || "à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ",
              background: "#1e293b", color: "#fff" });
          }
        },
        error: () => {
          hideLoading();
          isSubmitting = false;
          btn.disabled = false;
          btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
          Swal.fire({ icon: "error", title: "à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
            text: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ",
            background: "#1e293b", color: "#fff" });
        }
      });
    }
  });

  // ============================================================
  // doSaveToSheet â€” à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡ Google Sheet
  // ============================================================
  function doSaveToSheet(formData, btn, successMsg) {
    btn.disabled = true;
    btn.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...`;
    showLoading("à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸‡à¸£à¸°à¸šà¸š...");
    isSubmitting = true;

    $.ajax({
      method: "POST", url: SCRIPT_URL, data: formData, dataType: "json",
      success: (res) => {
        hideLoading(); isSubmitting = false;
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
        if (res.status === "success") {
          showToast(successMsg || "âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!");
          resetForm(); showPage("page-form");
        } else {
          Swal.fire({ icon:"error", title:"à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
            text: res.message || "à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ",
            background:"#1e293b", color:"#fff" });
        }
      },
      error: () => {
        hideLoading(); isSubmitting = false;
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
        Swal.fire({ icon:"error", title:"à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ",
          text:"à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ",
          background:"#1e293b", color:"#fff" });
      }
    });
  }

  // ============================================================
  // BUILD FLEX MESSAGE
  // ============================================================
  function buildFlexMessage(d, imgUrl) {
    return {
      type:    "flex",
      altText: `ğŸ“š à¹à¸ˆà¹‰à¸‡à¸ªà¸­à¸™à¹à¸—à¸™ | ${d.nameTeacher} â†’ ${d.nameTeacherSave} | à¸„à¸²à¸š ${d.numberAtPeriod} | à¸«à¹‰à¸­à¸‡ ${d.subjectRoom}`,
      contents: {
        type: "bubble",
        size: "mega",
        header: {
          type: "box", layout: "vertical", paddingAll: "0px",
          contents: [{
            type: "image", url: imgUrl,
            size: "full", aspectRatio: "16:9", aspectMode: "cover"
          }]
        },
        body: {
          type: "box", layout: "vertical",
          backgroundColor: "#ff99ff", paddingAll: "18px", spacing: "md",
          contents: [
            {
              type: "box", layout: "vertical",
              backgroundColor: "#00000077", paddingAll: "5px", cornerRadius: "xl",
              contents: [
                { type:"text", text:"ğŸ“š à¹à¸ˆà¹‰à¸‡à¸à¸²à¸£à¸ªà¸­à¸™à¹à¸—à¸™",      color:"#ffffff", size:"xl", weight:"bold", align:"center" },
                { type:"text", text:"à¸„à¸£à¸¹à¸‚à¸²à¸” â€¢ à¸¥à¸² â€¢ à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£", color:"#ffffffbb", size:"sm", align:"center", margin:"xs" }
              ]
            },
            makeRow("ğŸ‘©â€ğŸ« à¸œà¸¹à¹‰à¸¥à¸²à¸ªà¸­à¸™",    d.nameTeacher),
            makeRow("ğŸ‘¨â€ğŸ« à¸œà¸¹à¹‰à¸ªà¸­à¸™à¹à¸—à¸™",  d.nameTeacherSave),
            makeRow("â° à¸„à¸²à¸šà¸—à¸µà¹ˆà¸ªà¸­à¸™à¹à¸—à¸™", `à¸„à¸²à¸š ${d.numberAtPeriod}`),
            makeRow("ğŸ“– à¸§à¸´à¸Šà¸²",         d.subjectSave),
            makeRow("ğŸ« à¸«à¹‰à¸­à¸‡à¹€à¸£à¸µà¸¢à¸™",    d.subjectRoom),
            { type:"separator", margin:"md", color:"#334155" },
            makeRow("ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ", d.thaiDate),
            makeRow("ğŸ• à¹€à¸§à¸¥à¸²",   d.thaiTime),
          ]
        },
        footer: {
          type: "box", layout: "vertical",
          backgroundColor: "#ec4899", paddingAll: "12px",
          contents: [{
            type:"text", text:"â¤ï¸ à¸£à¸°à¸šà¸šà¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸ªà¸­à¸™à¹à¸—à¸™ | à¸„à¸£à¸¹à¸­à¸±à¹‹à¸™ à¹ƒà¸ˆà¸”à¸µ",
            color:"#ffffff", size:"xs", align:"center", wrap:true
          }]
        }
      }
    };
  }

  function makeRow(label, value) {
    return {
      type: "box", layout: "horizontal",
      contents: [
        { type:"text", text:label, color:"#444444", size:"sm", weight:"bold", flex:5, wrap:true },
        { type:"text", text:value, color:"#444444", size:"sm", weight:"bold", flex:6, align:"end", wrap:true }
      ]
    };
  }

  // ============================================================
  // updateEnvBadge â€” à¹à¸ªà¸”à¸‡ badge + hint à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸à¸±à¸š 2 à¸Šà¸¸à¸”à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
  // ============================================================
  function updateEnvBadge(inClient, errMsg) {
    const badge     = document.getElementById("liffStatusBadge");
    const hint      = document.getElementById("confirmHint");
    const submitBtn = document.getElementById("submitBtn");
    if (!badge) return;

    if (errMsg) {
      badge.className = "liff-badge liff-badge-warn";
      badge.innerHTML = `<i class="bi bi-exclamation-triangle-fill mr-1"></i>LIFF Error`;
    } else if (inClient) {
      // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 1: à¸¡à¸·à¸­à¸–à¸·à¸­ LINE in-app
      badge.className = "liff-badge liff-badge-ok";
      badge.innerHTML = `<i class="bi bi-phone-fill mr-1"></i>à¸¡à¸·à¸­à¸–à¸·à¸­ (LINE App) â€” à¹à¸Šà¸£à¹Œà¸à¹ˆà¸­à¸™ â†’ à¸šà¸±à¸™à¸—à¸¶à¸`;
    } else {
      // à¸Šà¸¸à¸”à¸—à¸µà¹ˆ 2: Web Browser
      badge.className = "liff-badge liff-badge-info";
      badge.innerHTML = `<i class="bi bi-display mr-1"></i>Web Browser â€” à¸šà¸±à¸™à¸—à¸¶à¸à¸à¹ˆà¸­à¸™ â†’ à¹à¸Šà¸£à¹Œ`;
    }
    badge.classList.remove("hidden");

    if (submitBtn && !submitBtn.disabled) {
      submitBtn.innerHTML = `<i class="bi bi-send-fill"></i> à¸¢à¸·à¸™à¸¢à¸±à¸™ + à¹à¸Šà¸£à¹Œ`;
    }

    if (hint) {
      if (inClient && !errMsg) {
        hint.innerHTML = `<i class="bi bi-phone-fill mr-1 text-green-400"></i>
          <strong class="text-green-400">à¸¡à¸·à¸­à¸–à¸·à¸­:</strong> à¸à¸”à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œ LINE à¸—à¸±à¸™à¸—à¸µ â†’ à¸šà¸±à¸™à¸—à¸¶à¸`;
      } else {
        hint.innerHTML = `<i class="bi bi-display mr-1 text-blue-400"></i>
          <strong class="text-blue-400">Browser:</strong> à¸à¸”à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ à¸šà¸±à¸™à¸—à¸¶à¸ â†’ à¹€à¸›à¸´à¸”à¹à¸Šà¸£à¹Œ LINE`;
      }
    }
  }

  // ============================================================
  // RESET FORM
  // ============================================================
  function resetForm() {
    ["nameTeacher","nameTeacherSave","numberAtPeriod","subjectSave","subjectRoom"]
      .forEach(id => document.getElementById(id).value = "");
    uploadedImageBase64 = null;
    fileInput.value = "";
    imgPreviewWrapper.classList.add("hidden");
    uploadPlaceholder.classList.remove("hidden");
  }

  // ============================================================
  // LIFF INIT
  // ============================================================
  document.getElementById("year").textContent = new Date().getFullYear();

  liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true })
    .then(() => {
      const inClient = liff.isInClient();
      const loggedIn = liff.isLoggedIn();
      console.log("LIFF ready | inClient:", inClient, "| loggedIn:", loggedIn);

      if (!loggedIn) {
        liff.login({ redirectUri: window.location.href });
        return;
      }
      updateEnvBadge(inClient);
    })
    .catch(err => {
      console.warn("LIFF init error:", err);
      updateEnvBadge(false, err.message);
    });
  </script>
</body>
</html>
