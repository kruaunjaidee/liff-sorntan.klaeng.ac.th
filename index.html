<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
    <style>
        * { box-sizing: border-box; }
        body { font-family: "Kanit", sans-serif; }

        .glow-green { text-shadow: 0 0 8px rgba(74,222,128,0.9), 0 0 20px rgba(74,222,128,0.5); }
        .glow-blue  { text-shadow: 0 0 6px rgba(99,179,237,0.8); }
        .glow-pink  { text-shadow: 0 0 6px rgba(236,72,153,0.8); }

        .glass-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        select, input[type="text"] {
            background: rgba(30,41,59,0.8) !important;
            border: 1.5px solid rgba(99,179,237,0.3) !important;
            color: #fff !important;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input[type="text"]:focus {
            border-color: #4ade80 !important;
            box-shadow: 0 0 0 3px rgba(74,222,128,0.2) !important;
            outline: none;
        }
        select option { background: #1e293b; color: #fff; }

        .upload-zone {
            border: 2px dashed rgba(99,179,237,0.4);
            transition: border-color 0.2s, background 0.2s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4ade80;
            background: rgba(74,222,128,0.05);
        }
        .upload-zone img { max-height: 160px; object-fit: contain; }

        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .confirm-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .confirm-row:last-child { border-bottom: none; }
        .confirm-label { color: #94a3b8; font-size: 0.85rem; }
        .confirm-value { color: #fff; font-weight: 600; font-size: 0.9rem; text-align: right; max-width: 60%; }

        .btn-primary { background: linear-gradient(135deg,#3b82f6,#1d4ed8); transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(59,130,246,0.4); }

        .btn-success { background: linear-gradient(135deg,#22c55e,#15803d); transition: all 0.2s; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34,197,94,0.4); }

        .btn-gray { background: rgba(71,85,105,0.6); border: 1px solid rgba(148,163,184,0.2); transition: all 0.2s; }
        .btn-gray:hover { background: rgba(100,116,139,0.6); transform: translateY(-2px); }

        .badge-blue {
            background: rgba(59,130,246,0.2); color: #93c5fd;
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 9999px; padding: 2px 10px; font-size: 0.75rem;
        }

        #loadingOverlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.7); z-index: 9999;
            align-items: center; justify-content: center;
            flex-direction: column; gap: 16px;
        }
        #loadingOverlay.show { display: flex; }

        .spinner {
            width: 48px; height: 48px;
            border: 4px solid rgba(74,222,128,0.2);
            border-top-color: #4ade80;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: #1e293b; border: 1px solid #4ade80; color: #fff;
            padding: 12px 24px; border-radius: 12px; font-size: 0.9rem;
            z-index: 9998; opacity: 0; transition: opacity 0.3s;
            pointer-events: none; white-space: nowrap;
        }
        #toast.show { opacity: 1; }

        #imgPreviewWrapper { position: relative; }
        #removeImgBtn {
            position: absolute; top: 8px; right: 8px;
            background: rgba(239,68,68,0.8); border: none; color: #fff;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            font-size: 1rem; display: flex; align-items: center; justify-content: center;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡∏ç‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à */
        #shareNowBtn {
            background: linear-gradient(135deg,#22c55e,#15803d);
            transition: all 0.2s;
        }
        #shareNowBtn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34,197,94,0.5); }
        #skipShareBtn {
            background: rgba(71,85,105,0.6);
            border: 1px solid rgba(148,163,184,0.2);
            transition: all 0.2s;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black text-white min-h-screen flex flex-col items-center justify-start p-4 sm:p-6 pb-24">

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p class="text-green-400 font-semibold text-sm" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- TOAST -->
    <div id="toast"></div>

    <!-- HEADER -->
    <div class="text-center mb-6 mt-2">
        <img src="https://lh3.googleusercontent.com/d/1hTcB5YnvnJtMg0l4fIO5Jo20QbKF5_wh"
            class="w-28 h-auto mb-3 mx-auto rounded-xl shadow-lg" onerror="this.style.display='none'" />
        <h3 class="text-2xl sm:text-3xl font-bold glow-green tracking-wide">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
        <p class="text-sm text-slate-400 mt-1">‡∏Ñ‡∏£‡∏π‡∏Ç‡∏≤‡∏î ‚Ä¢ ‡∏•‡∏≤ ‚Ä¢ ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</p>
        <h5 class="text-base text-pink-400 glow-pink mt-1">‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡πã‡∏ô ‡πÉ‡∏à‡∏î‡∏µ</h5>
    </div>

    <!-- ===== PAGE 1: FORM ===== -->
    <div class="page active w-full max-w-xl" id="page-form">
        <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8 space-y-5">

            <div class="flex items-center gap-2 mb-2">
                <i class="bi bi-pencil-square text-green-400 text-xl"></i>
                <span class="font-semibold text-lg glow-green">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</span>
            </div>

            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-person-x-fill mr-1 text-red-400"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô
                </label>
                <select id="nameTeacher" class="w-full rounded-xl p-3 text-white" required>
                    <option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô ‚Äî</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏≤‡∏£‡∏µ ‡∏ö‡∏±‡∏ß‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡πÑ‡∏ó‡∏£‡∏¢‡πâ‡∏≠‡∏¢‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏•‡∏¥‡∏®</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏±‡∏ó‡∏£‡∏û‡∏á‡∏®‡πå ‡∏£‡∏ß‡∏á‡∏ú‡∏∂‡πâ‡∏á‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏õ‡∏ô‡∏±‡∏®‡∏ç‡∏≤ ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏°‡∏≤‡∏Å</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ß‡∏≤‡∏ì‡∏µ ‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏£‡∏µ</option>
                    <option>‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ‡∏´‡∏ç‡∏¥‡∏á‡∏†‡∏≤‡∏£‡∏¥‡∏©‡∏≤ ‡∏ò‡∏ô‡∏™‡∏¥‡∏£‡∏¥‡∏á‡∏≤‡∏°</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏°‡∏ì‡∏ë‡∏≤‡∏ó‡∏¥‡∏û‡∏¢‡πå ‡∏Ñ‡∏µ‡∏£‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ß‡∏á‡∏®‡πå</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏õ‡∏≤‡∏ì‡∏µ ‡∏≠‡∏¥‡∏ô‡∏≠‡∏á‡∏Å‡∏≤‡∏£</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏∏‡∏ä‡∏ô‡∏≤‡∏è ‡πÅ‡∏ñ‡∏•‡∏á‡∏™‡∏±‡∏ï‡∏¢‡πå</option>
                    <option>‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏∏‡∏ö‡∏•‡∏ß‡∏£‡∏£‡∏ì ‡∏Å‡∏±‡∏ô‡∏ï‡∏∞‡πÅ‡∏Å‡πâ‡∏ß</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏• ‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡∏°‡∏µ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏±‡πà‡∏ô</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏û‡∏ä‡∏£‡∏ô‡∏†‡∏≤ ‡∏ú‡∏≤‡∏î‡∏ú‡πà‡∏≠‡∏á</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏±‡∏ó‡∏ß‡∏±‡∏ô ‡∏®‡∏£‡∏µ‡∏†‡∏±‡∏Å‡∏î‡∏µ</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏£‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏™‡∏≤‡∏¢‡∏î‡∏µ</option>
                </select>
            </div>

            <!-- ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-person-check-fill mr-1 text-green-400"></i>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </label>
                <select id="nameTeacherSave" class="w-full rounded-xl p-3 text-white" required>
                    <option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô ‚Äî</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏≠‡∏≤‡∏£‡∏µ ‡∏ö‡∏±‡∏ß‡∏Ñ‡∏∏‡πâ‡∏°‡∏†‡∏±‡∏¢</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò‡πå ‡πÑ‡∏ó‡∏£‡∏¢‡πâ‡∏≠‡∏¢‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏•‡∏¥‡∏®</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏∏‡∏†‡∏±‡∏ó‡∏£‡∏û‡∏á‡∏®‡πå ‡∏£‡∏ß‡∏á‡∏ú‡∏∂‡πâ‡∏á‡∏£‡∏∏‡πà‡∏á‡πÇ‡∏£‡∏à‡∏ô‡πå</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏õ‡∏ô‡∏±‡∏®‡∏ç‡∏≤ ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏°‡∏≤‡∏Å</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ß‡∏≤‡∏ì‡∏µ ‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏£‡∏µ</option>
                    <option>‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ‡∏´‡∏ç‡∏¥‡∏á‡∏†‡∏≤‡∏£‡∏¥‡∏©‡∏≤ ‡∏ò‡∏ô‡∏™‡∏¥‡∏£‡∏¥‡∏á‡∏≤‡∏°</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏°‡∏ì‡∏ë‡∏≤‡∏ó‡∏¥‡∏û‡∏¢‡πå ‡∏Ñ‡∏µ‡∏£‡∏µ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ß‡∏á‡∏®‡πå</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏õ‡∏≤‡∏ì‡∏µ ‡∏≠‡∏¥‡∏ô‡∏≠‡∏á‡∏Å‡∏≤‡∏£</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏ô‡∏∏‡∏ä‡∏ô‡∏≤‡∏è ‡πÅ‡∏ñ‡∏•‡∏á‡∏™‡∏±‡∏ï‡∏¢‡πå</option>
                    <option>‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏¢‡∏ï‡∏£‡∏µ‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏∏‡∏ö‡∏•‡∏ß‡∏£‡∏£‡∏ì ‡∏Å‡∏±‡∏ô‡∏ï‡∏∞‡πÅ‡∏Å‡πâ‡∏ß</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏ì‡∏±‡∏ê‡∏û‡∏• ‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå ‡∏°‡∏µ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏±‡πà‡∏ô</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏û‡∏ä‡∏£‡∏ô‡∏†‡∏≤ ‡∏ú‡∏≤‡∏î‡∏ú‡πà‡∏≠‡∏á</option>
                    <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏°‡∏±‡∏ó‡∏ß‡∏±‡∏ô ‡∏®‡∏£‡∏µ‡∏†‡∏±‡∏Å‡∏î‡∏µ</option>
                    <option>‡∏ô‡∏≤‡∏¢‡∏™‡∏£‡∏ô‡∏±‡∏ô‡∏ó‡πå ‡∏™‡∏≤‡∏¢‡∏î‡∏µ</option>
                </select>
            </div>

            <!-- ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-clock-fill mr-1 text-yellow-400"></i>‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </label>
                <select id="numberAtPeriod" class="w-full rounded-xl p-3 text-white" required>
                    <option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô ‚Äî</option>
                    <option value="1">‡∏Ñ‡∏≤‡∏ö 1</option>
                    <option value="2">‡∏Ñ‡∏≤‡∏ö 2</option>
                    <option value="3">‡∏Ñ‡∏≤‡∏ö 3</option>
                    <option value="4">‡∏Ñ‡∏≤‡∏ö 4</option>
                    <option value="5">‡∏Ñ‡∏≤‡∏ö 5</option>
                    <option value="6">‡∏Ñ‡∏≤‡∏ö 6</option>
                    <option value="7">‡∏Ñ‡∏≤‡∏ö 7</option>
                    <option value="8">‡∏Ñ‡∏≤‡∏ö 8</option>
                    <option value="9">‡∏Ñ‡∏≤‡∏ö 9</option>
                </select>
            </div>

            <!-- ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-book-fill mr-1 text-blue-400"></i>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </label>
                <input type="text" id="subjectSave" class="w-full rounded-xl p-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢, ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" required />
            </div>

            <!-- ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-door-open-fill mr-1 text-purple-400"></i>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô
                </label>
                <input type="text" id="subjectRoom" class="w-full rounded-xl p-3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/1, ‡∏°.3/4" required />
            </div>

            <!-- ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û -->
            <div>
                <label class="block text-sm font-medium glow-blue mb-1">
                    <i class="bi bi-image-fill mr-1 text-pink-400"></i>‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö <span class="badge-blue ml-1">‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</span>
                </label>
                <div id="uploadZone" class="upload-zone rounded-xl p-4 text-center">
                    <div id="uploadPlaceholder">
                        <i class="bi bi-cloud-arrow-up-fill text-3xl text-slate-400 block mb-2"></i>
                        <p class="text-sm text-slate-400">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                        <p class="text-xs text-slate-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG, PNG, WEBP (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)</p>
                    </div>
                    <div id="imgPreviewWrapper" class="hidden">
                        <img id="imgPreview" src="" alt="preview" class="mx-auto rounded-lg" />
                        <button id="removeImgBtn" type="button" title="‡∏•‡∏ö‡∏†‡∏≤‡∏û">√ó</button>
                    </div>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" />
                </div>
            </div>

            <!-- Submit -->
            <button type="button" id="goConfirmBtn"
                class="btn-primary w-full text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 text-base mt-2">
                <i class="bi bi-arrow-right-circle-fill"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
            </button>
        </div>
    </div>

    <!-- ===== PAGE 2: CONFIRM ===== -->
    <div class="page w-full max-w-xl" id="page-confirm">
        <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8">

            <div class="flex items-center gap-2 mb-5">
                <i class="bi bi-check2-circle text-green-400 text-2xl"></i>
                <span class="font-bold text-xl glow-green">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</span>
            </div>

            <div id="confirmImgBlock" class="hidden mb-4">
                <img id="confirmImgPreview" src="" class="w-full max-h-44 object-cover rounded-xl border border-slate-600" />
            </div>

            <div class="space-y-1 mb-6" id="confirmTable">
                <div class="confirm-row"><span class="confirm-label">üë©‚Äçüè´ ‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô</span><span class="confirm-value" id="c-nameTeacher">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">üë®‚Äçüè´ ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</span><span class="confirm-value" id="c-nameTeacherSave">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">‚è∞ ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà</span><span class="confirm-value" id="c-numberAtPeriod">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">üìñ ‡∏ß‡∏¥‡∏ä‡∏≤</span><span class="confirm-value" id="c-subjectSave">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">üè´ ‡∏´‡πâ‡∏≠‡∏á</span><span class="confirm-value" id="c-subjectRoom">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span class="confirm-value" id="c-date">‚Äî</span></div>
                <div class="confirm-row"><span class="confirm-label">üïê ‡πÄ‡∏ß‡∏•‡∏≤</span><span class="confirm-value" id="c-time">‚Äî</span></div>
            </div>

            <div class="flex gap-3">
                <button id="backBtn"
                    class="btn-gray flex-1 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2">
                    <i class="bi bi-arrow-left-circle"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button id="submitBtn"
                    class="btn-success flex-1 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 text-base">
                    <i class="bi bi-send-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- ===== PAGE 3: SUCCESS + SHARE ===== -->
    <!--
        ‚≠ê KEY: ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
           ‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ" ‡πÄ‡∏õ‡πá‡∏ô <button> ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô DOM
           ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å shareTargetPicker ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
           ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ "user gesture" ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô async chain
    -->
    <div class="page w-full max-w-xl" id="page-success">
        <div class="glass-card rounded-2xl shadow-2xl p-6 sm:p-8 text-center">
            <div class="text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold glow-green mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <p class="text-slate-400 text-sm mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢<br>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>

            <!-- ‚≠ê ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ real user gesture ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö shareTargetPicker -->
            <button id="shareNowBtn"
                class="w-full text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3 text-lg mb-3">
                <i class="bi bi-share-fill text-xl"></i> üì§ ‡πÅ‡∏ä‡∏£‡πå Flex Message ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ!
            </button>

            <button id="skipShareBtn"
                class="w-full text-slate-300 font-medium py-3 rounded-xl flex items-center justify-center gap-2 text-sm">
                <i class="bi bi-x-circle"></i> ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå (‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á)
            </button>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="fixed bottom-0 w-full bg-slate-900/80 backdrop-blur-sm text-center py-3 text-xs text-pink-400 glow-pink z-40">
        ‚ù§Ô∏è ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡πã‡∏ô ‡πÉ‡∏à‡∏î‡∏µ ¬© <span id="year"></span>
    </footer>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
    // ==============================
    // CONFIG
    // ==============================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8FMpndZve9-cBaR76IBFDxHSFpZtNt_k5WyJ-mPtTO5GHaTf64dlz79kkwTufpDhP/exec";
    const LIFF_ID    = "2000563749-Yh67UIqr";

    // ==============================
    // STATE
    // ==============================
    let uploadedImageBase64 = null;
    let pendingFlexMessage  = null;   // ‡πÄ‡∏Å‡πá‡∏ö flex ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ä‡∏£‡πå

    // ==============================
    // HELPERS
    // ==============================
    function showPage(id) {
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showLoading(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...") {
        document.getElementById("loadingText").textContent = text;
        document.getElementById("loadingOverlay").classList.add("show");
    }
    function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("show");
    }

    function showToast(msg, duration = 3000) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), duration);
    }

    function getThaiDate() {
        const d = new Date();
        const days   = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];
        const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
        return `‡∏ß‡∏±‡∏ô${days[d.getDay()]}‡∏ó‡∏µ‡πà ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }
    function getThaiTime() {
        const d = new Date();
        return d.toLocaleTimeString("th-TH", { hour: "2-digit", minute: "2-digit" }) + " ‡∏ô.";
    }

    // ==============================
    // IMAGE UPLOAD
    // ==============================
    const uploadZone        = document.getElementById("uploadZone");
    const fileInput         = document.getElementById("fileInput");
    const imgPreview        = document.getElementById("imgPreview");
    const imgPreviewWrapper = document.getElementById("imgPreviewWrapper");
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");

    uploadZone.addEventListener("click", () => fileInput.click());
    uploadZone.addEventListener("dragover",  e => { e.preventDefault(); uploadZone.classList.add("dragover"); });
    uploadZone.addEventListener("dragleave", () => uploadZone.classList.remove("dragover"));
    uploadZone.addEventListener("drop", e => {
        e.preventDefault();
        uploadZone.classList.remove("dragover");
        const f = e.dataTransfer.files[0];
        if (f) processFile(f);
    });
    fileInput.addEventListener("change", () => {
        if (fileInput.files[0]) processFile(fileInput.files[0]);
    });

    function processFile(file) {
        if (!file.type.startsWith("image/")) { showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"); return; }
        if (file.size > 5 * 1024 * 1024)     { showToast("‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB"); return; }
        const reader = new FileReader();
        reader.onload = e => {
            uploadedImageBase64 = e.target.result.split(",")[1];
            imgPreview.src = e.target.result;
            imgPreviewWrapper.classList.remove("hidden");
            uploadPlaceholder.classList.add("hidden");
        };
        reader.readAsDataURL(file);
    }

    document.getElementById("removeImgBtn").addEventListener("click", e => {
        e.stopPropagation();
        uploadedImageBase64 = null;
        fileInput.value = "";
        imgPreviewWrapper.classList.add("hidden");
        uploadPlaceholder.classList.remove("hidden");
    });

    // ==============================
    // PAGE 1 ‚Üí PAGE 2 (CONFIRM)
    // ==============================
    document.getElementById("goConfirmBtn").addEventListener("click", () => {
        const fields = [
            { id: "nameTeacher",    label: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô" },
            { id: "nameTeacherSave",label: "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô" },
            { id: "numberAtPeriod", label: "‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô" },
            { id: "subjectSave",    label: "‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô" },
            { id: "subjectRoom",    label: "‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô" },
        ];
        for (const f of fields) {
            const el = document.getElementById(f.id);
            if (!el.value.trim()) {
                showToast(`‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å: ${f.label}`);
                el.focus();
                return;
            }
        }

        document.getElementById("c-nameTeacher").textContent    = document.getElementById("nameTeacher").value;
        document.getElementById("c-nameTeacherSave").textContent = document.getElementById("nameTeacherSave").value;
        document.getElementById("c-numberAtPeriod").textContent  = "‡∏Ñ‡∏≤‡∏ö " + document.getElementById("numberAtPeriod").value;
        document.getElementById("c-subjectSave").textContent    = document.getElementById("subjectSave").value;
        document.getElementById("c-subjectRoom").textContent    = document.getElementById("subjectRoom").value;
        document.getElementById("c-date").textContent           = getThaiDate();
        document.getElementById("c-time").textContent           = getThaiTime();

        const confirmImgBlock   = document.getElementById("confirmImgBlock");
        const confirmImgPreview = document.getElementById("confirmImgPreview");
        if (uploadedImageBase64) {
            confirmImgPreview.src = imgPreview.src;
            confirmImgBlock.classList.remove("hidden");
        } else {
            confirmImgBlock.classList.add("hidden");
        }

        showPage("page-confirm");
    });

    document.getElementById("backBtn").addEventListener("click", () => showPage("page-form"));

    // ==============================
    // PAGE 2 ‚Üí SUBMIT (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sheet)
    // ==============================
    document.getElementById("submitBtn").addEventListener("click", submitData);

    function submitData() {
        const data = {
            opt:            "savedata",
            nameTeacher:    document.getElementById("nameTeacher").value,
            nameTeacherSave:document.getElementById("nameTeacherSave").value,
            numberAtPeriod: document.getElementById("numberAtPeriod").value,
            subjectSave:    document.getElementById("subjectSave").value,
            subjectRoom:    document.getElementById("subjectRoom").value,
            thaiDate:       getThaiDate(),
            thaiTime:       getThaiTime(),
            imageBase64:    uploadedImageBase64 || "",
        };

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE user (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        try {
            const token = liff.getDecodedIDToken();
            data.uid   = token?.sub  || "";
            data.uname = token?.name || "";
            data.uimg  = token?.picture || "";
        } catch(e) {}

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;

        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

        $.ajax({
            method:   "POST",
            url:      SCRIPT_URL,
            data:     data,
            dataType: "json",
            success: (res) => {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i class="bi bi-send-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á`;

                if (res.status === "success") {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex message ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏≠‡πÅ‡∏ä‡∏£‡πå
                    const imgUrl = (res.imageUrl && res.imageUrl.length > 10)
                        ? res.imageUrl
                        : "https://lh3.googleusercontent.com/d/1hTcB5YnvnJtMg0l4fIO5Jo20QbKF5_wh";

                    pendingFlexMessage = buildFlexMessage(data, imgUrl);

                    // ‚≠ê ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ success ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ" ‡∏£‡∏≠ user ‡∏Å‡∏î
                    showPage("page-success");

                } else {
                    alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (res.message || "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"));
                }
            },
            error: () => {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i class="bi bi-send-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á`;
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
            }
        });
    }

    // ==============================
    // PAGE 3: ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå (real user gesture ‚úÖ)
    // ==============================
    document.getElementById("shareNowBtn").addEventListener("click", function() {
        // ‚≠ê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å shareTargetPicker ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å click event = user gesture ‡∏à‡∏£‡∏¥‡∏á
        if (!pendingFlexMessage) {
            showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Flex Message");
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ shareTargetPicker ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        if (!liff.isApiAvailable("shareTargetPicker")) {
            showToast("‚ö†Ô∏è ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
            resetAndGoHome();
            return;
        }

        liff.shareTargetPicker([pendingFlexMessage], { isMultiple: true })
            .then((res) => {
                pendingFlexMessage = null;
                if (res) {
                    showToast("‚úÖ ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } else {
                    // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏¥‡∏î picker ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    showToast("‚ÑπÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå");
                }
                setTimeout(resetAndGoHome, 1500);
            })
            .catch((err) => {
                console.error("shareTargetPicker error:", err);
                pendingFlexMessage = null;
                showToast("‚ö†Ô∏è ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
                setTimeout(resetAndGoHome, 2000);
            });
    });

    document.getElementById("skipShareBtn").addEventListener("click", function() {
        pendingFlexMessage = null;
        showToast("‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå ‚Äî ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
        setTimeout(resetAndGoHome, 1200);
    });

    // ==============================
    // RESET & GO HOME
    // ==============================
    function resetAndGoHome() {
        document.getElementById("nameTeacher").value    = "";
        document.getElementById("nameTeacherSave").value = "";
        document.getElementById("numberAtPeriod").value  = "";
        document.getElementById("subjectSave").value    = "";
        document.getElementById("subjectRoom").value    = "";
        uploadedImageBase64 = null;
        document.getElementById("fileInput").value = "";
        imgPreviewWrapper.classList.add("hidden");
        uploadPlaceholder.classList.remove("hidden");
        showPage("page-form");
    }

    // ==============================
    // BUILD FLEX MESSAGE
    // ==============================
    function buildFlexMessage(d, imgUrl) {
        return {
            type:     "flex",
            altText:  `üìö ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô | ${d.nameTeacher} ‚Üí ${d.nameTeacherSave} | ‡∏Ñ‡∏≤‡∏ö ${d.numberAtPeriod} | ‡∏´‡πâ‡∏≠‡∏á ${d.subjectRoom}`,
            contents: {
                type: "bubble",
                size: "mega",
                header: {
                    type:   "box",
                    layout: "vertical",
                    paddingAll: "0px",
                    contents: [{
                        type:        "image",
                        url:         imgUrl,
                        size:        "full",
                        aspectRatio: "16:9",
                        aspectMode:  "cover"
                    }]
                },
                body: {
                    type:            "box",
                    layout:          "vertical",
                    backgroundColor: "#ff99ff",
                    paddingAll:      "18px",
                    spacing:         "md",
                    contents: [
                        {
                            type:   "box",
                            layout: "vertical",
                            backgroundColor: "#00000077",
                            paddingAll:  "5px",
                            cornerRadius: "xl",
                            contents: [
                                { type:"text", text:"üìö ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô", color:"#ffffff", size:"xl", weight:"bold", align:"center" },
                                { type:"text", text:"‡∏Ñ‡∏£‡∏π‡∏Ç‡∏≤‡∏î ‚Ä¢ ‡∏•‡∏≤ ‚Ä¢ ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£", color:"#ffffffbb", size:"sm", align:"center", margin:"xs" }
                            ]
                        },
                        makeRow("üë©‚Äçüè´ ‡∏ú‡∏π‡πâ‡∏•‡∏≤‡∏™‡∏≠‡∏ô",    d.nameTeacher),
                        makeRow("üë®‚Äçüè´ ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô",  d.nameTeacherSave),
                        makeRow("‚è∞ ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô", `‡∏Ñ‡∏≤‡∏ö ${d.numberAtPeriod}`),
                        makeRow("üìñ ‡∏ß‡∏¥‡∏ä‡∏≤",         d.subjectSave),
                        makeRow("üè´ ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",    d.subjectRoom),
                        { type:"separator", margin:"md", color:"#334155" },
                        makeRow("üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",        d.thaiDate),
                        makeRow("üïê ‡πÄ‡∏ß‡∏•‡∏≤",          d.thaiTime),
                    ]
                },
                footer: {
                    type:            "box",
                    layout:          "vertical",
                    backgroundColor: "#ec4899",
                    paddingAll:      "12px",
                    contents: [{
                        type:  "text",
                        text:  "‚ù§Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô | ‡∏Ñ‡∏£‡∏π‡∏≠‡∏±‡πã‡∏ô ‡πÉ‡∏à‡∏î‡∏µ",
                        color: "#ffffff",
                        size:  "xs",
                        align: "center",
                        wrap:  true
                    }]
                }
            }
        };
    }

    function makeRow(label, value) {
        return {
            type:   "box",
            layout: "horizontal",
            contents: [
                { type:"text", text:label, color:"#444444", size:"sm", weight:"bold", flex:5, wrap:true },
                { type:"text", text:value, color:"#444444", size:"sm", weight:"bold", flex:6, align:"end", wrap:true }
            ]
        };
    }

    // ==============================
    // LIFF INIT
    // ==============================
    document.getElementById("year").textContent = new Date().getFullYear();

    liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true })
        .then(() => {
            if (!liff.isLoggedIn()) liff.login();
        })
        .catch(err => {
            console.warn("LIFF init error:", err);
            // ‡∏ñ‡πâ‡∏≤ LIFF init ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô browser ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤) ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ form ‡πÑ‡∏î‡πâ
        });
    </script>
</body>
</html>
